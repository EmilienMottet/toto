<!DOCTYPE html>
<head>
<title>Consolidation Debug</title>
<meta charset="utf-8">
<link rel="stylesheet"
	href="css/jquery-ui-1.11.1.css">
<style>
body {
	font-family: "Helvetica Neue", Helvetica, sans-serif;
	margin: 1em auto 4em auto;
	position: relative;
	tab-size: 2;
	width: 95%;
}

h1 {
	font-size: 64px;
	font-weight: 300;
	letter-spacing: -2px;
	margin: .3em 0 .5em 0;
}

h2 {
	margin-top: 2em;
}

h1,h2 {
	text-rendering: optimizeLegibility;
}

.link {
	fill: none;
	stroke: #666;
	stroke-width: 1.5px;
}

.broken {
	stroke: red;
}

circle {
	fill: #F1396D;
	stroke: white;
	stroke-width: 1.5px;
}

text {
	font: 10px sans-serif;
	pointer-events: none;
	text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
}

#content {
	width: 100%;
	margin-top: 1em;
}

#details {
	margin-left: 980px;
	min-height: 500px;
}

#graph {
	width: 960px;
	height: 500px;
	float: left;
}

#legend {
	width: 100%;
	padding: 1em;
}
</style>
</head>
<body>
	<h1>Consolidation Debug</h1>
	<div id="filtering">
		<form>
			<input id="uri" name="uri" type="text" placeholder="uri"
				style="width: 300px;" /> <input name="limit" type="number" min="1"
				step="1" value="5" placeholder="Limit"> <input type="submit"
				value="Submit">
		</form>
	</div>
	<div id="content">
		<div id="graph">
			<div id="graph-output"></div>
		</div>
		<div id="details"></div>
	</div>
	<div id="footer">
		<div id="legend"></div>
	</div>
	<script src="js/jquery-2.1.1.min.js"></script>
	<script src="js/jquery-ui-1.11.1.min.js"></script>
	<script src="js/d3.v3.min.js"></script>
	<script>
		var uri = getUrlParameter("uri");
		var limit = getUrlParameter("limit");
		limit = (limit == undefined || limit == "") ? 5 : limit;

		$('input[name=uri]').val(uri);
		$('input[name=limit]').val(limit);

		$.ajax({
			url : "api/list_arcs",
			data : {
				uri : decodeURIComponent(uri),
				limit : limit
			},
			type : "GET",
			dataType : "json",
			success : function(resp) {
				loadGraph(resp);
			}
		});

		$("#uri").bind("change paste keyup", function() {
			loadUris();
		});

		loadUris();

		function loadUris() {
			$.ajax({
				url : "api/list_documents",
				data : {
					prefix : $('#uri').val(),
					limit : 10,
				},
				type : "GET",
				dataType : "json",
				success : function(resp) {
					var uris = [];
					resp.documents.forEach(function(document) {
						uris.push(document.uri);
					});
					$("#uri").autocomplete({
						source : uris
					});
				}
			});
		}

		function loadGraph(resp) {
			if (resp.arcs.length > 0) {
				var color = d3.scale.category20();
				var nodes = {};
				var linkTypes = [];
				var nodeTypes = [];

				// Compute the distinct nodes from the arcs.
				resp.arcs.forEach(function(link) {
					link.source = nodes[link.source] || (nodes[link.source] = {
						name : link.source,
						type : link.sourceType
					});
					link.target = nodes[link.target] || (nodes[link.target] = {
						name : link.target,
						type : link.targetType
					});
					if ($.inArray(link.type, linkTypes) == -1) {
						linkTypes.push(link.type);
					}
					if (link.targetType != undefined
							&& $.inArray(link.targetType, nodeTypes) == -1) {
						nodeTypes.push(link.targetType);
					}
					if (link.sourceType != undefined
							&& $.inArray(link.sourceType, nodeTypes) == -1) {
						nodeTypes.push(link.sourceType);
					}
				});

				var width = 960, height = 500;

				var force = d3.layout.force().nodes(d3.values(nodes)).links(
						resp.arcs).size([ width, height ]).linkDistance(120)
						.charge(-300).on("tick", tick).start();

				var svg = d3.select("#graph-output").append("svg").attr(
						"width", width).attr("height", height);

				// Per-type markers, as they don't inherit styles.
				svg.append("defs").selectAll("marker").data(linkTypes).enter()
						.append("marker").attr("id", function(d) {
							return d;
						}).attr("viewBox", "0 -5 10 10").attr("refX", 15).attr(
								"refY", -1.5).attr("markerWidth", 6).attr(
								"markerHeight", 6).attr("orient", "auto")
						.append("path").attr("d", "M0,-5L10,0L0,5");

				var path = svg
						.append("g")
						.selectAll("path")
						.data(force.links())
						.enter()
						.append("path")
						.attr(
								"class",
								function(d) {
									return "link "
											+ d.type
											+ " "
											+ ((d.targetType == null || d.sourceType == null) ? "broken"
													: "");
								}).attr("marker-end", function(d) {
							return "url(#" + d.type + ")";
						});

				var circle = svg.append("g").selectAll("circle").data(
						force.nodes()).enter().append("circle").attr("r", 6)
						.style("fill", function(d) {
							return color(d.type);
						}).on("click", function(d) {
							if (d.name != null) {
								showDetails(d.name, true)
							}
						}).call(force.drag);

				var text = svg.append("g").selectAll("text")
						.data(force.nodes()).enter().append("text")
						.attr("x", 8).attr("y", ".31em").text(function(d) {
							return d.name;
						});

				$('#graph').css('border', '1px solid #CCC');

				var legend = "<h4>Legend</h4>";
				legend += "<table>";
				var closedTr = false;
				$.each(nodeTypes, function(index, nodeType) {
					if (index > 0 && index % 5 == 0) {
						legend += "</tr>";
						closedTr = true;
					}
					if (index % 5 == 0) {
						legend += "<tr>";
						closedTr = false;
					}
					legend += "<td style=\"width: 20px; background-color:"
							+ color(nodeType) + ";\"></td>"
					legend += "<td style=\"padding: 4px;\">"
							+ (nodeType == "" ? "__UNDEFINED__" : nodeType)
							+ "</td>";
				});
				if (!closedTr) {
					legend += "</tr>";
				}
				legend += "</table>";

				$('#legend').html(legend);
				showDetails($("#uri").val(), true);
			} else {
				showDetails($("#uri").val(), false);
			}

			// Use elliptical arc path segments to doubly-encode directionality.
			function tick() {
				path.attr("d", linkArc);
				circle.attr("transform", transform);
				text.attr("transform", transform);
			}

			function linkArc(d) {
				var dx = d.target.x - d.source.x, dy = d.target.y - d.source.y, dr = Math
						.sqrt(dx * dx + dy * dy);
				return "M" + d.source.x + "," + d.source.y + "A" + dr + ","
						+ dr + " 0 0,1 " + d.target.x + "," + d.target.y;
			}

			function transform(d) {
				return "translate(" + d.x + "," + d.y + ")";
			}

			function showDetails(uri, hasArcs) {
				$.ajax({
					url : "api/get_document",
					data : {
						uri : uri
					},
					type : "GET",
					dataType : "json",
					success : function(details) {
						if (details != null) {
							var html = "<h3>Node details</h3>";
							html += "uri='" + details.uri + "'";
							var metas = "<h4>Metas</h4><ul>";
							$.each(details.metas.metas,
									function(metaName, meta) {
										metas += "<li>" + metaName + "='";
										$.each(meta.values, function(index,
												value) {
											metas += value + " ";
										});
										metas += "'</li>";
									});
							metas += "</ul>";

							var directives = "<h4>Directives</h4><ul>";
							$.each(details.directives.directives, function(
									dirName, dir) {
								directives += "<li>" + dirName + "='";
								$.each(dir.values, function(index, value) {
									directives += value + " ";
								});
								directives += "'</li>";
							});
							directives += "</ul>";

							html += metas;
							html += directives;
							$("#details").html(html);

							if (!hasArcs) {
								$('#graph-output').html("<p>No arcs</p>");
							}
						} else {
							var html = "<h3>Node details</h3>"
							html += "Not available";
							$("#details").html(html);
						}
					}
				});
			}
		}

		function getUrlParameter(parameterName) {
			var sPageURL = window.location.search.substring(1);
			var sURLVariables = sPageURL.split('&');
			for (var i = 0; i < sURLVariables.length; i++) {
				var sParameterName = sURLVariables[i].split('=');
				if (sParameterName[0] == parameterName) {
					return decodeURIComponent(sParameterName[1]);
				}
			}
		}
	</script>
</body>
